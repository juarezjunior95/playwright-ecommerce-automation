name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'

    - name: Install dependencies
      # Certifique-se de ter feito o push do package-lock.json atualizado para evitar o erro EUSAGE
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests
      # O config.ts agora gera o test-results.json automaticamente
      run: npx playwright test

    - name: Extract Test Results
      if: always()
      run: |
        # Extrai os dados do JSON para vari√°veis de ambiente
        PASSED=$(jq '.stats.expected' test-results.json)
        FAILED=$(jq '.stats.unexpected' test-results.json)
        SKIPPED=$(jq '.stats.skipped' test-results.json)
        DURATION=$(jq '.stats.duration' test-results.json | awk '{print $1/1000}')
        
        echo "PASSED=$PASSED" >> $GITHUB_ENV
        echo "FAILED=$FAILED" >> $GITHUB_ENV
        echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
        echo "TEST_TIME=$DURATION" >> $GITHUB_ENV

    - name: Generate GitHub Step Summary
      if: always()
      run: |
        echo "### üìä Playwright Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Status | Quantity |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚úÖ Passed | ${{ env.PASSED }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚ùå Failed | ${{ env.FAILED }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚è≠Ô∏è Skipped | ${{ env.SKIPPED }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total test duration:** ${{ env.TEST_TIME }}s" >> $GITHUB_STEP_SUMMARY
        
        # Lista os t√≠tulos dos testes que falharam em ingl√™s
        if [ "${{ env.FAILED }}" != "0" ]; then
          echo "#### ‚ùå Failed Tests Details" >> $GITHUB_STEP_SUMMARY
          jq -r '.suites[].specs[].tests[] | select(.status=="unexpected") | "- " + .title' test-results.json >> $GITHUB_STEP_SUMMARY
        fi

    - name: Notify Slack
      if: always()
      run: |
        if [ "${{ env.FAILED }}" == "0" ]; then
          COLOR="good"
          ICON="‚úÖ"
        else
          COLOR="danger"
          ICON="‚ùå"
        fi

        curl -X POST -H 'Content-type: application/json' \
        --data "{
          \"attachments\": [
            {
              \"color\": \"$COLOR\",
              \"title\": \"$ICON Playwright: ${{ env.PASSED }} Passed | ${{ env.FAILED }} Failed\",
              \"title_link\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"text\": \"*Repository:* ${{ github.repository }}\n*Branch:* \`${{ github.ref_name }}\`\n*Duration:* ${{ env.TEST_TIME }}s\n\n*Summary:* ‚úÖ ${{ env.PASSED }} | ‚ùå ${{ env.FAILED }} | ‚è≠Ô∏è ${{ env.SKIPPED }}\",
              \"footer\": \"GitHub Actions Report\"
            }
          ]
        }" \
        ${{ secrets.SLACK_WEBHOOK }}

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30