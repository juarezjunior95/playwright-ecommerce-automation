name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests
      # Geramos o report em JSON para extrair os nomes dos testes que falharam
      run: npx playwright test --reporter=html,json > test-results.json || true

    - name: Generate Job Summary
      if: always()
      run: |
        echo "### üìä Playwright Test Results" >> $GITHUB_STEP_SUMMARY
        PASSED=$(jq '.stats.expected' test-results.json)
        FAILED=$(jq '.stats.unexpected' test-results.json)
        
        echo "| Status | Quantity |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
        
        if [ "$FAILED" -ne "0" ]; then
          echo "#### ‚ùå Failed Tests Details (English)" >> $GITHUB_STEP_SUMMARY
          jq -r '.suites[].specs[].tests[] | select(.status=="unexpected") | "- " + .title' test-results.json >> $GITHUB_STEP_SUMMARY
        fi

    - name: Slack Notification
      if: always()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_TITLE: 'Playwright: $PASSED Passed | $FAILED Failed'
        SLACK_MESSAGE: 'Repository: ${{ github.repository }}\nSummary: ‚úÖ $PASSED | ‚ùå $FAILED'
        SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}