name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests
      # Geramos o report em JSON para extrair os nomes dos testes que falharam
      run: npx playwright test --reporter=html,json > test-results.json || true

    - name: Generate Job Summary
      if: always()
      run: |
        echo "### üìä Playwright Test Results" >> $GITHUB_STEP_SUMMARY
        
        # Extrair totais usando ferramentas de shell (jq √© nativo no Ubuntu do GitHub)
        PASSED=$(jq '.stats.expected' test-results.json)
        FAILED=$(jq '.stats.unexpected' test-results.json)
        SKIPPED=$(jq '.stats.skipped' test-results.json)
        DURATION=$(jq '.stats.duration' test-results.json | awk '{print $1/1000 "s"}')

        echo "| Status | Quantity |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚è© Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total Duration:** $DURATION" >> $GITHUB_STEP_SUMMARY
        
        # Listar t√≠tulos dos testes que falharam em Ingl√™s
        if [ "$FAILED" -ne "0" ]; then
          echo "#### ‚ùå Failed Tests Details" >> $GITHUB_STEP_SUMMARY
          jq -r '.suites[].specs[].tests[] | select(.status=="unexpected") | "- " + .title' test-results.json >> $GITHUB_STEP_SUMMARY
        fi

    - name: Slack Notification
      if: always()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_USERNAME: 'Playwright Bot'
        SLACK_ICON: https://playwright.dev/img/playwright-logo.svg
        SLACK_TITLE: 'Playwright Suite: ${{ job.status }}'
        SLACK_MESSAGE: |
          *Repository:* ${{ github.repository }}
          *Branch:* `${{ github.ref_name }}`
          *Summary:* ‚úÖ ${{ env.PASSED }} | ‚ùå ${{ env.FAILED }} | ‚è© ${{ env.SKIPPED }}
          *Check the GitHub Actions Summary for failure details.*
        SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}
        SLACK_FOOTER: 'GitHub Actions Report'

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30